worker_processes  1;

# very important for running within docker container! If not set to off, docker container immediately stops.
daemon off;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    log_format  main '"$time_iso8601","$remote_addr","$scheme","$host",'
             '"$request_method","$uri","$status","$http_referer",'
             '"$http_user_agent","$http_accept","$http_content_type",'
             '"$sent_http_content_type","$request_length","$bytes_sent",'
             '"$request_time","$http_x_oidc_client_id","$arg_access_token",'
             '"$http_authorization","$headers","$args"';

    access_log  /usr/local/openresty/logs/access.log  main;
    error_log /usr/local/openresty/logs/error.log;
	
    sendfile        on;

    keepalive_timeout  65;

    # HTTP server
    server {
        listen  80;
        listen  [::]:80;
        
        server_name SERVER_NAME;
		
		more_set_headers 'Access-Control-Allow-Origin: *' 'Access-Control-Allow-Headers: Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since' 'Access-Control-Allow-Methods: GET,POST,PUT,DELETE,HEAD,OPTIONS';
		
        set $headers '';
        access_by_lua 'ngx.var.headers = ngx.req.raw_header()';

        location / {
            root   html;
            index  index.html index.htm;
        }

        location ~ /o/(oauth2|resources) {
            proxy_pass           http://10.255.255.9:9080;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
            proxy_set_header     X-SSL-Verified $ssl_client_verify;
            proxy_set_header     X-SSL-Cert-Serial $ssl_client_serial;
        }

        location /account {
            proxy_pass           http://10.255.255.9:9080;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
            proxy_set_header     X-SSL-Verified $ssl_client_verify;
            proxy_set_header     X-SSL-Cert-Serial $ssl_client_serial;
        }

        location /clvitra {
            client_max_body_size    0;
            proxy_pass           http://10.255.255.10:8080;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
        
        location /swagger {
            proxy_pass           http://10.255.255.10:8080;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
        
        location /doc {
            root   static;
            index  index.html;
        }

        location /ocd {
            proxy_pass           http://10.255.255.24:8080/ocd;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        location /sss/achso {
            proxy_pass           http://10.255.255.2:8080/achso;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
        
        location /sss/bnp {
            proxy_pass           http://10.255.255.2:8080/bnp;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
		
		location /sss/bnpapp {
            proxy_pass           http://10.255.255.2:8080/bnpapp;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
        
        location /mobsos-surveys/s/ {
            root    static;
            autoindex on;
        }
		
		location /mobsos-dashboard/s/ {
            root    static;
            autoindex on;
        }
        
        location /mobsos-surveys {
            proxy_pass           http://10.255.255.24:8081/mobsos-surveys;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
		
		location /mobsos-qv {
            proxy_pass           http://10.255.255.24:8083/QVS;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }
		
		location /mobsos-dashboard {
            proxy_pass           http://10.255.255.24:8082/mobsos-dashboard;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        location /tethys {
            proxy_pass           http://10.255.255.23:8081/Tethys;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        location /tethys-userstorage {
            client_max_body_size 0;
            proxy_pass           http://10.255.255.23:8081/ChocoloperTethys;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        location /owncloud {
            client_max_body_size 0;
            proxy_pass           http://10.255.255.23:8082/owncloud;
	    proxy_redirect       http://api.learning-layers.eu:8082/owncloud/  https://$host:$server_port/owncloud/;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        location /device {
            root   static;
            index  index.html;
        }

        location /deviceflow {
            proxy_pass           http://10.255.255.23:3001/;
            proxy_redirect       default;
            proxy_set_header     Host     $host;
            proxy_set_header     X-Real-IP     $remote_addr;
        }

        error_page  404              /404.html;
        error_page   500 502 503 504  /50x.html;
        
    }
}
# vim: set ts=4 sw=4 sts=4 expandtab :